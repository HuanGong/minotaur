#include "urlsafe64.h"

int urlsafe64_encode(const uint8_t *src, int src_len, char *dst) {
  static const char _t64[64] = {
    'A','B','C','D','E','F','G','H','I','J','K','L','M',
    'N','O','P','Q','R','S','T','U','V','W','X','Y','Z',
    'a','b','c','d','e','f','g','h','i','j','k','l','m',
    'n','o','p','q','r','s','t','u','v','w','x','y','z',
    '0','1','2','3','4','5','6','7','8','9','-','_'
  };
  int i, loop = src_len / 3;
  char *mark = dst;
  for (i = 0; i < loop; ++i, src+=3) {
    *dst++ = _t64[((src[0] >> 2))];
    *dst++ = _t64[((src[0] & 0x03) << 4) | (src[1] >> 4)];
    *dst++ = _t64[((src[1] & 0x0f) << 2) | (src[2] >> 6)];
    *dst++ = _t64[((src[2] & 0x3f))];
  }
  switch (src_len % 3) {
    case 2:
      *dst++ = _t64[((src[0] >> 2))];
      *dst++ = _t64[((src[0] & 0x03) << 4) | (src[1] >> 4)];
      *dst++ = _t64[((src[1] & 0x0f) << 2)];
      break;
    case 1:
      *dst++ = _t64[((src[0] >> 2))];
      *dst++ = _t64[((src[0] & 0x03) << 4)];
      break;
  }
  return dst - mark;
}

int urlsafe64_decode(const char *src, int src_len, uint8_t *dst) {
  static const char _t256[256] = {
    -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,
    -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,
    -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,
    52,53,54,55,56,57,58,59,60,61,-1,-1,-1,64,-1,-1,
    -1, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9,10,11,12,13,14,
    15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,63,
    -1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,
    41,42,43,44,45,46,47,48,49,50,51,-1,-1,-1,-1,-1,
    -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,
    -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,
    -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,
    -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,
    -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,
    -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1
  };
  int i, loop = src_len / 4;
  uint8_t *mark = dst;
  char p0, p1, p2, p3;
  const uint8_t *s = (const uint8_t *) src;
  for (i = 0; i < loop; ++i) {
    if ((p0 = _t256[(int)*s++]) < 0) return -1;
    if ((p1 = _t256[(int)*s++]) < 0) return -1;
    if ((p2 = _t256[(int)*s++]) < 0) return -1;
    if ((p3 = _t256[(int)*s++]) < 0) return -1;
    *dst++ = (p0 << 2) | (p1 >> 4);
    if (p2 != 64) *dst++ = ((p1 << 4) & 0xf0) | (p2 >> 2);
    if (p3 != 64) *dst++ = ((p2 << 6) & 0xc0) | (p3);
  }
  switch (src_len % 4) {
    case 0:
      break;
    case 3:
      if ((p0 = _t256[(int)*s++]) < 0) return -1;
      if ((p1 = _t256[(int)*s++]) < 0) return -1;
      if ((p2 = _t256[(int)*s++]) < 0) return -1;
      *dst++ = (p0 << 2) | (p1 >> 4);
      if (p2 != 64) *dst++ = ((p1 << 4) & 0xf0) | (p2 >> 2);
      if ((p2 & 0x3) != 0) return -1;
      break;
    case 2:
      if ((p0 = _t256[(int)*s++]) < 0) return -1;
      if ((p1 = _t256[(int)*s++]) < 0) return -1;
      *dst++ = (p0 << 2) | (p1 >> 4);
      if ((p1 & 0xf) != 0) return -1;
      break;
    default:
      return -2;
  }
  return dst - mark;
}
